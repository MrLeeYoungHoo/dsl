name: LiveContainer IPA Build (Unsigned)

on:
  push:
    # 只在 main 分支打 tag 时触发，或者你可以改为 push 到 main 分支
    tags:
      - 'v*.*.*' 
  workflow_dispatch: # 允许手动触发

jobs:
  build_ios:
    # 必须使用 macOS 运行器
    runs-on: macos-latest
    
    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v4

      # --------------------- Flutter 环境配置 ---------------------
      - name: 🎯 Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' 
          
      - name: 📦 Get Flutter dependencies and clean build
        # ------------------- 核心修改: 设置工作目录 -------------------
        working-directory: ./simple_live_app 
        # -----------------------------------------------------------
        run: |
          flutter clean
          flutter pub get
        
      # --------------------- 编译未签名的 .app 文件 ---------------------
      
      - name: 🔨 Build iOS App (Unsigned)
        # --no-codesign 标志跳过签名
        # ------------------- 核心修改: 设置工作目录 -------------------
        working-directory: ./simple_live_app 
        # -----------------------------------------------------------
        run: flutter build ios --release --no-codesign
        
      # --------------------- 手动打包为 LiveContainer 适用的 .ipa ---------------------
      
      - name: ⚙️ Create Unsigned IPA Archive
        # 此步骤在项目根目录运行，以便于生成 .ipa 文件
        run: |
          # 1. 定义 .app 文件的路径，注意路径前缀加上了 'simple_live_app/'
          APP_NAME="dart_simple_live"
          APP_PATH="simple_live_app/build/ios/iphoneos/Runner.app"
          IPA_OUTPUT_NAME="${APP_NAME}_unsigned_release.ipa"
          
          # 2. 检查 .app 文件是否生成
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: Runner.app not found at $APP_PATH. Build failed."
            exit 1
          fi
          
          # 3. 创建一个名为 Payload 的文件夹 (IPA 文件的标准结构)
          mkdir -p Payload
          
          # 4. 将 .app 文件复制到 Payload 文件夹中
          echo "Copying $APP_PATH to Payload/"
          cp -R "$APP_PATH" Payload/
          
          # 5. 压缩 Payload 文件夹并命名为 .ipa 文件
          echo "Creating $IPA_OUTPUT_NAME"
          zip -r "$IPA_OUTPUT_NAME" Payload/
          
          # 6. 清理 Payload 文件夹
          rm -rf Payload
          
      # --------------------- 上传 Artifact ---------------------
      
      - name: ⬆️ Upload IPA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: livecontainer_ipa
          path: "*.ipa" # 匹配上一步生成的 .ipa 文件
          retention-days: 7 

      # --------------------- 创建 GitHub Release (可选) ---------------------
      
      - name: 📝 Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') # 仅在 tag 触发时创建 Release
        with:
          files: "*.ipa"
          name: LiveContainer App Release ${{ github.ref_name }}
          draft: false
          prerelease: true
