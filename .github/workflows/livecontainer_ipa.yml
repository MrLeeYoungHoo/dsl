name: LiveContainer IPA Build (Unsigned)

on:
  push:
    # åªåœ¨ main åˆ†æ”¯æ‰“ tag æ—¶è§¦å‘ï¼Œæˆ–è€…ä½ å¯ä»¥æ”¹ä¸º push åˆ° main åˆ†æ”¯
    tags:
      - 'v*.*.*' 
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build_ios:
    # LiveContainer éœ€è¦çš„ App å¿…é¡»åœ¨ macOS è¿è¡Œå™¨ä¸Šç¼–è¯‘
    runs-on: macos-latest
    
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # --------------------- Flutter ç¯å¢ƒé…ç½® ---------------------
      - name: ğŸ¯ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' 
          
      - name: ğŸ“¦ Get Flutter dependencies and clean build
        run: |
          flutter clean
          flutter pub get
        
      # --------------------- ç¼–è¯‘æœªç­¾åçš„ .app æ–‡ä»¶ ---------------------
      
      - name: ğŸ”¨ Build iOS App (Unsigned)
        # ä½¿ç”¨ --no-codesign æ ‡å¿—è·³è¿‡ç­¾åæ­¥éª¤
        # è¿™å°†ç”Ÿæˆ build/ios/iphoneos/Runner.app æ–‡ä»¶
        run: flutter build ios --release --no-codesign
        
      # --------------------- æ‰‹åŠ¨æ‰“åŒ…ä¸º LiveContainer é€‚ç”¨çš„ .ipa ---------------------
      
      - name: âš™ï¸ Create Unsigned IPA Archive
        run: |
          # 1. å®šä¹‰ .app æ–‡ä»¶çš„è·¯å¾„
          # LiveContainer éœ€è¦çš„æ˜¯æœªç­¾åçš„ Release ç‰ˆæœ¬ .app æ–‡ä»¶
          APP_NAME="dart_simple_live"
          APP_PATH="build/ios/iphoneos/Runner.app"
          IPA_OUTPUT_NAME="${APP_NAME}_unsigned_release.ipa"
          
          # 2. æ£€æŸ¥ .app æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: Runner.app not found at $APP_PATH. Build failed."
            exit 1
          fi
          
          # 3. åˆ›å»ºä¸€ä¸ªåä¸º Payload çš„æ–‡ä»¶å¤¹ (IPA æ–‡ä»¶çš„æ ‡å‡†ç»“æ„)
          mkdir -p Payload
          
          # 4. å°† .app æ–‡ä»¶å¤åˆ¶åˆ° Payload æ–‡ä»¶å¤¹ä¸­
          cp -R "$APP_PATH" Payload/
          
          # 5. å‹ç¼© Payload æ–‡ä»¶å¤¹å¹¶å‘½åä¸º .ipa æ–‡ä»¶
          zip -r "$IPA_OUTPUT_NAME" Payload/
          
          # 6. æ¸…ç† Payload æ–‡ä»¶å¤¹
          rm -rf Payload
          
      # --------------------- ä¸Šä¼  Artifact ---------------------
      
      - name: â¬†ï¸ Upload IPA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: livecontainer_ipa
          path: "*.ipa" # åŒ¹é…ä¸Šä¸€æ­¥ç”Ÿæˆçš„ .ipa æ–‡ä»¶
          retention-days: 7 

      # --------------------- åˆ›å»º GitHub Release (å¯é€‰) ---------------------
      
      - name: ğŸ“ Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') # ä»…åœ¨ tag è§¦å‘æ—¶åˆ›å»º Release
        with:
          files: "*.ipa"
          name: LiveContainer App Release ${{ github.ref_name }}
          # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œæˆ–æ ¹æ®éœ€è¦è®¾ç½®
          draft: false
          prerelease: true