name: LiveContainer IPA Build (Unsigned)

on:
  push:
    # åªåœ¨ main åˆ†æ”¯æ‰“ tag æ—¶è§¦å‘ï¼Œæˆ–è€…ä½ å¯ä»¥æ”¹ä¸º push åˆ° main åˆ†æ”¯
    tags:
      - 'v*.*.*' 
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build_ios:
    # å¿…é¡»ä½¿ç”¨ macOS è¿è¡Œå™¨
    runs-on: macos-latest
    
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # --------------------- Flutter ç¯å¢ƒé…ç½® ---------------------
      - name: ğŸ¯ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' 
          
      - name: ğŸ“¦ Get Flutter dependencies and clean build
        # ------------------- æ ¸å¿ƒä¿®æ”¹: è®¾ç½®å·¥ä½œç›®å½• -------------------
        working-directory: ./simple_live_app 
        # -----------------------------------------------------------
        run: |
          flutter clean
          flutter pub get
        
      # --------------------- ç¼–è¯‘æœªç­¾åçš„ .app æ–‡ä»¶ ---------------------
      
      - name: ğŸ”¨ Build iOS App (Unsigned)
        # --no-codesign æ ‡å¿—è·³è¿‡ç­¾å
        # ------------------- æ ¸å¿ƒä¿®æ”¹: è®¾ç½®å·¥ä½œç›®å½• -------------------
        working-directory: ./simple_live_app 
        # -----------------------------------------------------------
        run: flutter build ios --release --no-codesign
        
      # --------------------- æ‰‹åŠ¨æ‰“åŒ…ä¸º LiveContainer é€‚ç”¨çš„ .ipa ---------------------
      
      - name: âš™ï¸ Create Unsigned IPA Archive
        # æ­¤æ­¥éª¤åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼Œä»¥ä¾¿äºç”Ÿæˆ .ipa æ–‡ä»¶
        run: |
          # 1. å®šä¹‰ .app æ–‡ä»¶çš„è·¯å¾„ï¼Œæ³¨æ„è·¯å¾„å‰ç¼€åŠ ä¸Šäº† 'simple_live_app/'
          APP_NAME="dart_simple_live"
          APP_PATH="simple_live_app/build/ios/iphoneos/Runner.app"
          IPA_OUTPUT_NAME="${APP_NAME}_unsigned_release.ipa"
          
          # 2. æ£€æŸ¥ .app æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: Runner.app not found at $APP_PATH. Build failed."
            exit 1
          fi
          
          # 3. åˆ›å»ºä¸€ä¸ªåä¸º Payload çš„æ–‡ä»¶å¤¹ (IPA æ–‡ä»¶çš„æ ‡å‡†ç»“æ„)
          mkdir -p Payload
          
          # 4. å°† .app æ–‡ä»¶å¤åˆ¶åˆ° Payload æ–‡ä»¶å¤¹ä¸­
          echo "Copying $APP_PATH to Payload/"
          cp -R "$APP_PATH" Payload/
          
          # 5. å‹ç¼© Payload æ–‡ä»¶å¤¹å¹¶å‘½åä¸º .ipa æ–‡ä»¶
          echo "Creating $IPA_OUTPUT_NAME"
          zip -r "$IPA_OUTPUT_NAME" Payload/
          
          # 6. æ¸…ç† Payload æ–‡ä»¶å¤¹
          rm -rf Payload
          
      # --------------------- ä¸Šä¼  Artifact ---------------------
      
      - name: â¬†ï¸ Upload IPA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: livecontainer_ipa
          path: "*.ipa" # åŒ¹é…ä¸Šä¸€æ­¥ç”Ÿæˆçš„ .ipa æ–‡ä»¶
          retention-days: 7 

      # --------------------- åˆ›å»º GitHub Release (å¯é€‰) ---------------------
      
      - name: ğŸ“ Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') # ä»…åœ¨ tag è§¦å‘æ—¶åˆ›å»º Release
        with:
          files: "*.ipa"
          name: LiveContainer App Release ${{ github.ref_name }}
          draft: false
          prerelease: true
